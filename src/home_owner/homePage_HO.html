<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CleanConnect - Cleaning Services Marketplace</title>
    <style>
        :root {
            --primary-color: #ff5722;
            --secondary-color: #2196f3;
            --light-gray: #f5f5f5;
            --dark-gray: #757575;
            --white: #ffffff;
            --black: #333333;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
            --radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: var(--black);
            line-height: 1.6;
        }

        header {
            background-color: var(--white);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 15px 0;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            text-decoration: none;
        }

        .search-container {
            flex-grow: 1;
            margin: 0 20px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            font-size: 16px;
        }

        .search-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--dark-gray);
            cursor: pointer;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #e64a19;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
        }

        .btn-secondary:hover {
            background-color: #1976d2;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .service-card {
            display: flex;
            flex-direction: column;
            background-color: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: transform 0.3s;
            height: 100%;
        }

        .service-card:hover {
            transform: translateY(-5px);
        }

        .service-info {
            padding: 15px;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .card-actions {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
            padding-top: 10px;
        }

        .service-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        .service-title {
            font-size: 18px;
            margin-bottom: 5px;
            color: var(--black);
        }

        .service-price {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .service-description {
            color: var(--dark-gray);
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            height: 60px;
        }

        .service-provider {
            margin-top: auto;
            padding-top: 10px;
            border-top: 1px solid var(--light-gray);
            display: flex;
            align-items: center;
        }

        .provider-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 8px;
            border: 1px solid var(--light-gray);
        }

        .provider-name {
            font-size: 14px;
            color: var(--dark-gray);
        }

        .card-btn {
            padding: 8px 12px;
            font-size: 13px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 200;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: var(--white);
            margin: 10% auto;
            padding: 20px;
            border-radius: var(--radius);
            width: 80%;
            max-width: 600px;
            box-shadow: var(--shadow);
            animation: modalopen 0.3s;
        }

        @keyframes modalopen {
            from {opacity: 0; transform: translateY(-50px);}
            to {opacity: 1; transform: translateY(0);}
        }

        .close-button {
            color: var(--dark-gray);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover {
            color: var(--black);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            font-size: 16px;
        }

        .form-textarea {
            height: 100px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .filter-section {
            background-color: var(--white);
            padding: 15px;
            margin-top: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .filter-title {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .filter-chip {
            background-color: var(--light-gray);
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .filter-chip:hover, .filter-chip.active {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .section-title {
            font-size: 24px;
            margin: 30px 0 15px;
            color: var(--black);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tag {
            display: inline-block;
            background-color: var(--light-gray);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 5px;
            color: var(--dark-gray);
        }

        .error-message {
            color: red;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        /* User info in header */
        .user-info {
            display: flex;
            align-items: center;
            margin-left: 15px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 8px;
        }

        .user-name {
            font-weight: 500;
            margin-right: 10px;
        }
        
        .btn-logout {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: var(--radius);
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-left: 8px;
        }
        
        .btn-logout:hover {
            background-color: #d32f2f;
        }

        .welcome-banner {
            background-color: var(--white);
            padding: 15px;
            margin-top: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Nav tabs for main page and shortlist */
        .nav-tabs {
            display: flex;
            margin-top: 20px;
            background-color: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .nav-tab {
            padding: 15px 20px;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: background-color 0.3s;
            font-weight: 500;
        }

        .nav-tab.active {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .nav-tab:not(.active):hover {
            background-color: var(--light-gray);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Badge for shortlist count */
        .shortlist-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            margin-left: 5px;
        }

        /* Heart icon for shortlist */
        .heart-icon {
            color: #ccc;
            font-size: 18px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .heart-icon.active {
            color: #e91e63;
        }

        /* Service detail modal */
        .service-detail-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .service-detail-image {
            width: 40%;
            border-radius: var(--radius);
            overflow: hidden;
        }

        .service-detail-image img {
            width: 100%;
            height: auto;
            object-fit: cover;
        }

        .service-detail-info {
            width: 60%;
        }

        .service-detail-actions {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .no-services {
            text-align: center;
            padding: 30px;
            background-color: var(--white);
            border-radius: var(--radius);
            margin-top: 30px;
        }

        .booking-form {
            margin-top: 20px;
        }

        /* History styles */
        .history-item {
            background-color: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 15px;
            padding: 15px;
            display: flex;
            align-items: flex-start;
        }

        .history-image {
            width: 80px;
            height: 80px;
            border-radius: var(--radius);
            object-fit: cover;
            margin-right: 15px;
        }

        .history-info {
            flex-grow: 1;
        }

        .history-date {
            color: var(--dark-gray);
            font-size: 14px;
            margin-bottom: 5px;
        }

        .history-title {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .history-provider {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .history-status {
            margin-left: auto;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-completed {
            background-color: #4caf50;
            color: white;
        }

        .status-upcoming {
            background-color: #ff9800;
            color: white;
        }

        .status-cancelled {
            background-color: #f44336;
            color: white;
        }

        /* Analytics section */
        .analytics-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .analytics-card {
            background-color: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            text-align: center;
        }

        .analytics-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .analytics-label {
            color: var(--dark-gray);
            font-size: 14px;
        }

        .chart-container {
            background-color: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-top: 20px;
            height: 300px;
        }

        /* Responsive adjustments */
        @media screen and (max-width: 768px) {
            .header-content {
                flex-direction: column;
            }

            .search-container {
                margin: 15px 0;
                width: 100%;
            }

            .services-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
            }

            .welcome-banner {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .service-detail-container {
                flex-direction: column;
            }

            .service-detail-image, .service-detail-info {
                width: 100%;
            }

            .analytics-container {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
<header>
    <div class="container">
        <div class="header-content">
            <a href="#" class="logo">CleanConnect</a>
            <div class="search-container">
                <input type="text" class="search-input" id="search-input" placeholder="Search for cleaning services...">
                <button class="search-btn" id="search-btn">üîç</button>
            </div>
            <div style="display: flex; align-items: center;">
                <button class="btn" id="add-service-btn">+ Add Listing</button>
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar"></div>
                    <span class="user-name" id="username-display">Guest User</span>
                    <button class="btn-logout" id="logout-btn">Logout</button>
                </div>
            </div>
        </div>
    </div>
</header>

<main class="container">
    <div class="welcome-banner">
        <div>
            <h3>Welcome, <span id="welcome-username">Guest User</span>!</h3>
            <p>Find and save your favorite cleaning services for easy access.</p>
        </div>
        <div>
            <button class="btn" id="view-shortlist-btn">
                My Shortlist <span class="shortlist-badge" id="shortlist-count">0</span>
            </button>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <div class="nav-tab active" id="browse-tab">Browse Services</div>
        <div class="nav-tab" id="shortlist-tab">My Shortlist</div>
        <div class="nav-tab" id="history-tab">Booking History</div>
    </div>

    <!-- Browse Tab Content -->
    <div class="tab-content active" id="browse-content">
        <div class="filter-section">
            <h3 class="filter-title">Filter Services</h3>
            <div class="filter-options">
                <div class="filter-chip active" data-filter="all">All Services</div>
                <div class="filter-chip" data-filter="home">Home Cleaning</div>
                <div class="filter-chip" data-filter="office">Office Cleaning</div>
                <div class="filter-chip" data-filter="carpet">Carpet Cleaning</div>
                <div class="filter-chip" data-filter="windows">Window Cleaning</div>
                <div class="filter-chip" data-filter="deep">Deep Cleaning</div>
            </div>
        </div>

        <h2 class="section-title">Cleaning Services</h2>

        <div class="services-grid" id="services-container">
            <!-- Services will be dynamically generated here -->
        </div>
    </div>

    <!-- Shortlist Tab Content -->
    <div class="tab-content" id="shortlist-content">
        <div class="filter-section">
            <h3 class="filter-title">Search Your Shortlist</h3>
            <div class="search-container">
                <input type="text" class="search-input" id="shortlist-search-input" placeholder="Search your shortlisted services...">
                <button class="search-btn" id="shortlist-search-btn">üîç</button>
            </div>
        </div>

        <h2 class="section-title">
            My Shortlisted Services
            <button class="btn btn-secondary" id="clear-shortlist-btn" style="font-size: 14px;">Clear All</button>
        </h2>

        <div class="services-grid" id="shortlist-container">
            <!-- Shortlisted services will be dynamically generated here -->
        </div>
        
        <div class="no-services" id="no-shortlist" style="display: none;">
            <h3>Your shortlist is empty</h3>
            <p>Browse the services and add some to your shortlist!</p>
            <button class="btn" id="browse-services-btn" style="margin-top: 15px;">Browse Services</button>
        </div>
    </div>

    <!-- History Tab Content -->
    <div class="tab-content" id="history-content">
        <div class="filter-section">
            <h3 class="filter-title">Search Your Booking History</h3>
            <div class="search-container">
                <input type="text" class="search-input" id="history-search-input" placeholder="Search by service name, provider or date...">
                <button class="search-btn" id="history-search-btn">üîç</button>
            </div>
        </div>

        <!-- Analytics Section -->
        <h2 class="section-title">Cleaning Frequency</h2>
        <div class="analytics-container">
            <div class="analytics-card">
                <div class="analytics-value" id="total-bookings">0</div>
                <div class="analytics-label">Total Bookings</div>
            </div>
            <div class="analytics-card">
                <div class="analytics-value" id="avg-frequency">0</div>
                <div class="analytics-label">Days Between Cleanings</div>
            </div>
        </div>

        <h2 class="section-title">Booking History</h2>

        <div id="history-container">
            <!-- History items will be dynamically generated here -->
        </div>
        
        <div class="no-services" id="no-history" style="display: none;">
            <h3>You have no booking history yet</h3>
            <p>Browse services and make your first booking!</p>
            <button class="btn" id="browse-for-booking-btn" style="margin-top: 15px;">Browse Services</button>
        </div>
    </div>
</main>

<!-- Add/Edit Service Modal -->
<div id="service-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-modal">&times;</span>
        <h2 id="modal-title">Add New Service</h2>
        <form id="service-form">
            <input type="hidden" id="service-id">
            <div class="form-group">
                <label class="form-label" for="service-title">Service Title</label>
                <input type="text" class="form-input" id="service-title" required>
                <div class="error-message" id="title-error">Please enter a valid title</div>
            </div>
            <div class="form-group">
                <label class="form-label" for="service-category">Category</label>
                <select class="form-input" id="service-category" required>
                    <option value="">Select a category</option>
                    <option value="home">Home Cleaning</option>
                    <option value="office">Office Cleaning</option>
                    <option value="carpet">Carpet Cleaning</option>
                    <option value="windows">Window Cleaning</option>
                    <option value="deep">Deep Cleaning</option>
                </select>
                <div class="error-message" id="category-error">Please select a category</div>
            </div>
            <div class="form-group">
                <label class="form-label" for="service-price">Price (SGD)</label>
                <input type="number" class="form-input" id="service-price" min="1" step="0.01" required>
                <div class="error-message" id="price-error">Please enter a valid price</div>
            </div>
            <div class="form-group">
                <label class="form-label" for="service-description">Description</label>
                <textarea class="form-textarea" id="service-description" required></textarea>
                <div class="error-message" id="description-error">Please enter a description</div>
            </div>
            <div class="form-group">
                <label class="form-label" for="service-image">Image URL</label>
                <input type="text" class="form-input" id="service-image" placeholder="https://example.com/image.jpg">
                <div class="error-message" id="image-error">Please enter a valid URL</div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancel-button">Cancel</button>
                <button type="submit" class="btn" id="save-button">Save Service</button>
            </div>
        </form>
    </div>
</div>

<!-- Service Detail Modal -->
<div id="service-detail-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-detail-modal">&times;</span>
        <h2 id="detail-title">Service Details</h2>
        <div class="service-detail-container">
            <div class="service-detail-image">
                <img id="detail-image" src="" alt="Service image">
            </div>
            <div class="service-detail-info">
                <h3 id="detail-service-title"></h3>
                <p class="service-price" id="detail-price"></p>
                <p id="detail-category"></p>
                <p id="detail-description"></p>
                <div class="service-provider">
                    <img class="provider-avatar" id="detail-provider-avatar" src="" alt="Provider">
                    <span class="provider-name" id="detail-provider-name"></span>
                </div>
            </div>
        </div>
        <div class="service-detail-actions">
            <button class="btn btn-secondary" id="back-to-list">Back</button>
            <button class="btn" id="book-service-btn">Book Now</button>
        </div>
    </div>
</div>

<!-- Booking Modal -->
<div id="booking-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-booking-modal">&times;</span>
        <h2>Book Service</h2>
        <h3 id="booking-service-title"></h3>
        <form id="booking-form" class="booking-form">
            <input type="hidden" id="booking-service-id">
            <div class="form-group">
                <label class="form-label" for="booking-date">Preferred Date</label>
                <input type="date" class="form-input" id="booking-date" required>
            </div>
            <div class="form-group">
                <label class="form-label" for="booking-time">Preferred Time</label>
                <input type="time" class="form-input" id="booking-time" required>
            </div>
            <div class="form-group">
                <label class="form-label" for="booking-address">Address</label>
                <textarea class="form-textarea" id="booking-address" required></textarea>
            </div>
            <div class="form-group">
                <label class="form-label" for="booking-notes">Special Instructions (Optional)</label>
                <textarea class="form-textarea" id="booking-notes"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancel-booking">Cancel</button>
                <button type="submit" class="btn" id="confirm-booking">Confirm Booking</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Modal -->
<div id="delete-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-delete-modal">&times;</span>
        <h2>Confirm Deletion</h2>
        <p>Are you sure you want to delete this service? This action cannot be undone.</p>
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancel-delete-button">Cancel</button>
            <button type="button" class="btn" id="confirm-delete-button" style="background-color: #f44336;">Delete</button>
        </div>
    </div>
</div>

<!-- Logout Confirmation Modal -->
<div id="logout-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-logout-modal">&times;</span>
        <h2>Confirm Logout</h2>
        <p>Are you sure you want to log out of your account?</p>
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancel-logout-button">Cancel</button>
            <button type="button" class="btn" id="confirm-logout-button">Logout</button>
        </div>
    </div>
</div>

<script>
    // Global variables
    let currentUser = null; // Will store the current user information
    let services = []; // Will store fetched services
    let shortlist = []; // Will store shortlisted services
    let bookingHistory = []; // Will store booking history
    
    // API URL (change this to match your server)
    const API_URL = 'http://localhost:3000';
    
    // DOM elements
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');
    const shortlistSearchInput = document.getElementById('shortlist-search-input');
    const shortlistSearchBtn = document.getElementById('shortlist-search-btn');
    const historySearchInput = document.getElementById('history-search-input');
    const historySearchBtn = document.getElementById('history-search-btn');
    const servicesContainer = document.getElementById('services-container');
    const shortlistContainer = document.getElementById('shortlist-container');
    const historyContainer = document.getElementById('history-container');
    const shortlistCount = document.getElementById('shortlist-count');
    const noShortlist = document.getElementById('no-shortlist');
    const noHistory = document.getElementById('no-history');
    const browseTab = document.getElementById('browse-tab');
    const shortlistTab = document.getElementById('shortlist-tab');
    const historyTab = document.getElementById('history-tab');
    const browseContent = document.getElementById('browse-content');
    const shortlistContent = document.getElementById('shortlist-content');
    const historyContent = document.getElementById('history-content');
    const viewShortlistBtn = document.getElementById('view-shortlist-btn');
    const clearShortlistBtn = document.getElementById('clear-shortlist-btn');
    const browseServicesBtn = document.getElementById('browse-services-btn');
    const browseForBookingBtn = document.getElementById('browse-for-booking-btn');
    
    // User dropdown elements
    const logoutBtn = document.getElementById('logout-btn');
    const logoutModal = document.getElementById('logout-modal');
    const closeLogoutModal = document.getElementById('close-logout-modal');
    const cancelLogoutButton = document.getElementById('cancel-logout-button');
    const confirmLogoutButton = document.getElementById('confirm-logout-button');
    
    // Analytics elements
    const totalBookings = document.getElementById('total-bookings');
    const avgFrequency = document.getElementById('avg-frequency');
    
    // Service detail modal elements
    const serviceDetailModal = document.getElementById('service-detail-modal');
    const closeDetailModal = document.getElementById('close-detail-modal');
    const detailTitle = document.getElementById('detail-title');
    const detailServiceTitle = document.getElementById('detail-service-title');
    const detailPrice = document.getElementById('detail-price');
    const detailCategory = document.getElementById('detail-category');
    const detailDescription = document.getElementById('detail-description');
    const detailImage = document.getElementById('detail-image');
    const detailProviderAvatar = document.getElementById('detail-provider-avatar');
    const detailProviderName = document.getElementById('detail-provider-name');
    const backToListBtn = document.getElementById('back-to-list');
    const bookServiceBtn = document.getElementById('book-service-btn');
    
    // Booking modal elements
    const bookingModal = document.getElementById('booking-modal');
    const closeBookingModal = document.getElementById('close-booking-modal');
    const bookingServiceTitle = document.getElementById('booking-service-title');
    const bookingServiceId = document.getElementById('booking-service-id');
    const bookingForm = document.getElementById('booking-form');
    const cancelBooking = document.getElementById('cancel-booking');
    const confirmBooking = document.getElementById('confirm-booking');
    
    // Fetch all services from the server
    async function fetchServices() {
        try {
            showLoader(servicesContainer);
            const response = await fetch(`${API_URL}/api/services`);
            const data = await response.json();
            
            if (data.success) {
                services = data.services;
                renderServices(services);
            } else {
                showError(servicesContainer, 'Failed to load services');
            }
        } catch (error) {
            console.error('Error fetching services:', error);
            showError(servicesContainer, 'Failed to connect to server');
        }
    }
    
    // Fetch services by category
    async function fetchServicesByCategory(category) {
        try {
            showLoader(servicesContainer);
            const response = await fetch(`${API_URL}/api/services/filter/${category}`);
            const data = await response.json();
            
            if (data.success) {
                services = data.services;
                renderServices(services);
            } else {
                showError(servicesContainer, 'Failed to load services');
            }
        } catch (error) {
            console.error('Error fetching services by category:', error);
            showError(servicesContainer, 'Failed to connect to server');
        }
    }
    
    // Search services by keyword
    async function searchServicesAPI(keyword) {
        try {
            showLoader(servicesContainer);
            const response = await fetch(`${API_URL}/api/services/search?keyword=${encodeURIComponent(keyword)}`);
            const data = await response.json();
            
            if (data.success) {
                services = data.services;
                renderServices(services);
            } else {
                showError(servicesContainer, 'Failed to search services');
            }
        } catch (error) {
            console.error('Error searching services:', error);
            showError(servicesContainer, 'Failed to connect to server');
        }
    }
    
    // Fetch user's shortlist
    async function fetchShortlist() {
        if (!currentUser) {
            updateShortlistCount();
            return;
        }
        
        try {
            showLoader(shortlistContainer);
            const response = await fetch(`${API_URL}/api/shortlist/${currentUser.user_id}`);
            const data = await response.json();
            
            if (data.success) {
                shortlist = data.services;
                renderShortlist();
            } else {
                showError(shortlistContainer, 'Failed to load shortlist');
            }
        } catch (error) {
            console.error('Error fetching shortlist:', error);
            showError(shortlistContainer, 'Failed to connect to server');
        }
    }
    
    // Fetch user's booking history
    async function fetchBookingHistory() {
        if (!currentUser) {
            return;
        }
        
        try {
            showLoader(historyContainer);
            const response = await fetch(`${API_URL}/api/bookings/${currentUser.user_id}`);
            const data = await response.json();
            
            if (data.success) {
                bookingHistory = data.bookings;
                renderBookingHistory(bookingHistory);
                updateAnalytics(bookingHistory);
            } else {
                showError(historyContainer, 'Failed to load booking history');
            }
        } catch (error) {
            console.error('Error fetching booking history:', error);
            showError(historyContainer, 'Failed to connect to server');
        }
    }
    
    // Search booking history
    function searchBookingHistory(keyword) {
        if (!keyword) {
            renderBookingHistory(bookingHistory);
            return;
        }
        
        keyword = keyword.toLowerCase();
        const filtered = bookingHistory.filter(booking => 
            booking.service.title.toLowerCase().includes(keyword) || 
            booking.service.provider.name.toLowerCase().includes(keyword) || 
            booking.date.toLowerCase().includes(keyword) ||
            booking.status.toLowerCase().includes(keyword)
        );
        
        renderBookingHistory(filtered);
    }
    
    // Add service to shortlist
    async function addToShortlist(serviceId) {
        if (!currentUser) {
            alert('Please log in to add services to your shortlist');
            return;
        }
        
        try {
            const response = await fetch(`${API_URL}/api/shortlist/add`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId: currentUser.user_id,
                    serviceId: serviceId
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Find the service and add it to the shortlist if not already there
                const service = services.find(s => s.id === serviceId);
                if (service && !shortlist.some(s => s.id === serviceId)) {
                    shortlist.push(service);
                    updateShortlistCount();
                }
                
                // Update heart icons
                updateHeartIcons();
            } else {
                console.error('Failed to add to shortlist:', data.message);
            }
        } catch (error) {
            console.error('Error adding to shortlist:', error);
        }
    }
    
    // Remove service from shortlist
    async function removeFromShortlist(serviceId) {
        if (!currentUser) return;
        
        try {
            const response = await fetch(`${API_URL}/api/shortlist/remove`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId: currentUser.user_id,
                    serviceId: serviceId
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Remove from local shortlist
                shortlist = shortlist.filter(s => s.id !== serviceId);
                updateShortlistCount();
                renderShortlist();
                
                // Update heart icons
                updateHeartIcons();
            } else {
                console.error('Failed to remove from shortlist:', data.message);
            }
        } catch (error) {
            console.error('Error removing from shortlist:', error);
        }
    }
    
    // Clear entire shortlist
    async function clearShortlist() {
        if (!currentUser) return;
        
        try {
            const response = await fetch(`${API_URL}/api/shortlist/clear`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId: currentUser.user_id
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                shortlist = [];
                updateShortlistCount();
                renderShortlist();
                
                // Update heart icons
                updateHeartIcons();
            } else {
                console.error('Failed to clear shortlist:', data.message);
            }
        } catch (error) {
            console.error('Error clearing shortlist:', error);
        }
    }
    
    // Create a booking
    async function createBooking(serviceId, date, time, address, notes) {
    if (!currentUser) {
        alert('Please log in to book a service');
        return false;
    }
    
    try {
        const response = await fetch(`${API_URL}/api/bookings`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                userId: currentUser.user_id,
                serviceId: serviceId,
                date: date,
                time: time,
                address: address,
                notes: notes
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Get the service details
            const service = services.find(s => s.id === serviceId) || 
                           shortlist.find(s => s.id === serviceId);
            
            if (service) {
                // Create a new booking object and add it to bookingHistory
                const newBookingId = bookingHistory.length > 0 ? 
                                    Math.max(...bookingHistory.map(b => b.id)) + 1 : 1;
                
                const newBooking = {
                    id: newBookingId,
                    service: service,
                    date: date,
                    time: time,
                    address: address,
                    notes: notes || '',
                    status: 'Upcoming'  // Set status as Upcoming for new bookings
                };
                
                // Add the new booking to the booking history array
                bookingHistory.push(newBooking);
                
                // Refresh booking history display
                renderBookingHistory(bookingHistory);
                updateAnalytics(bookingHistory);
            }
            
            return true;
        } else {
            console.error('Failed to create booking:', data.message);
            return false;
        }
    } catch (error) {
        console.error('Error creating booking:', error);
        return false;
    }
}
    
    // Update shortlist count badge
    function updateShortlistCount() {
        shortlistCount.textContent = shortlist.length;
        if (shortlist.length === 0) {
            noShortlist.style.display = 'block';
        } else {
            noShortlist.style.display = 'none';
        }
    }
    
    // Update heart icons based on shortlist
    function updateHeartIcons() {
        const heartIcons = document.querySelectorAll('.heart-icon');
        heartIcons.forEach(icon => {
            const serviceId = parseInt(icon.getAttribute('data-id'));
            if (shortlist.some(service => service.id === serviceId)) {
                icon.classList.add('active');
            } else {
                icon.classList.remove('active');
            }
        });
    }
    
    // Create service card element
    function createServiceCard(service) {
        const card = document.createElement('div');
        card.className = 'service-card';
        
        const isShortlisted = shortlist.some(item => item.id === service.id);
        
        card.innerHTML = `
            <img class="service-image" src="${service.image}" alt="${service.title}">
            <div class="service-info">
                <h3 class="service-title">${service.title}</h3>
                <p class="service-price">SGD ${service.price.toFixed(2)}</p>
                <p class="service-description">${service.description}</p>
                <div class="service-provider">
                    <img class="provider-avatar" src="${service.provider.avatar}" alt="${service.provider.name}">
                    <span class="provider-name">${service.provider.name}</span>
                </div>
                <div class="card-actions">
                    <button class="btn card-btn view-details-btn" data-id="${service.id}">View Details</button>
                    <span class="heart-icon ${isShortlisted ? 'active' : ''}" data-id="${service.id}">‚ù§</span>
                </div>
            </div>
        `;
        
        // Add event listener for the heart icon
        const heartIcon = card.querySelector('.heart-icon');
        heartIcon.addEventListener('click', function() {
            const serviceId = parseInt(this.getAttribute('data-id'));
            toggleShortlist(serviceId);
        });
        
        // Add event listener for view details button
        const viewDetailsBtn = card.querySelector('.view-details-btn');
        viewDetailsBtn.addEventListener('click', function() {
            const serviceId = parseInt(this.getAttribute('data-id'));
            viewServiceDetails(serviceId);
        });
        
        return card;
    }
    
    // Create history item element
    function createHistoryItem(booking) {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        
        // Format status class
        let statusClass = '';
        switch(booking.status.toLowerCase()) {
            case 'completed':
                statusClass = 'status-completed';
                break;
            case 'upcoming':
                statusClass = 'status-upcoming';
                break;
            case 'cancelled':
                statusClass = 'status-cancelled';
                break;
            default:
                statusClass = '';
        }
        
        historyItem.innerHTML = `
            <img class="history-image" src="${booking.service.image}" alt="${booking.service.title}">
            <div class="history-info">
                <p class="history-date">${booking.date} at ${booking.time}</p>
                <h3 class="history-title">${booking.service.title}</h3>
                <p>${booking.service.description.substring(0, 100)}...</p>
                <div class="history-provider">
                    <img class="provider-avatar" src="${booking.service.provider.avatar}" alt="${booking.service.provider.name}">
                    <span class="provider-name">${booking.service.provider.name}</span>
                    <span class="history-status ${statusClass}">${booking.status}</span>
                </div>
            </div>
        `;
        
        // Add event listener to view service details
        historyItem.addEventListener('click', function() {
            viewServiceDetails(booking.service.id);
        });
        
        return historyItem;
    }
    
    // Toggle service in shortlist
    function toggleShortlist(serviceId) {
        if (!currentUser) {
            alert('Please log in to use the shortlist feature');
            return;
        }
        
        const isShortlisted = shortlist.some(item => item.id === serviceId);
        
        if (isShortlisted) {
            // Remove from shortlist
            removeFromShortlist(serviceId);
        } else {
            // Add to shortlist
            addToShortlist(serviceId);
        }
    }
    
    // View service details
    function viewServiceDetails(serviceId) {
        const service = services.find(s => s.id === serviceId) || 
                       shortlist.find(s => s.id === serviceId) ||
                       bookingHistory.find(b => b.service.id === serviceId)?.service;
        
        if (!service) return;
        
        // Populate modal with service details
        detailServiceTitle.textContent = service.title;
        detailPrice.textContent = `SGD ${service.price.toFixed(2)}`;
        
        // Format category name
        const categoryName = service.category.charAt(0).toUpperCase() + service.category.slice(1);
        detailCategory.textContent = `Category: ${categoryName} Cleaning`;
        
        detailDescription.textContent = service.description;
        detailImage.src = service.image;
        detailProviderAvatar.src = service.provider.avatar;
        detailProviderName.textContent = service.provider.name;
        
        // Setup booking button
        bookServiceBtn.setAttribute('data-id', service.id);
        
        // Show modal
        serviceDetailModal.style.display = 'block';
    }
    
    // Setup booking modal
    function setupBooking(serviceId) {
        const service = services.find(s => s.id === serviceId) || 
                       shortlist.find(s => s.id === serviceId) ||
                       bookingHistory.find(b => b.service.id === serviceId)?.service;
        
        if (!service) return;
        
        // Populate booking modal
        bookingServiceTitle.textContent = service.title;
        bookingServiceId.value = service.id;
        
        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('booking-date').min = today;
        
        // Show booking modal
        bookingModal.style.display = 'block';
        serviceDetailModal.style.display = 'none';
    }
    
    // Update analytics data based on booking history
    function updateAnalytics(bookings) {
        if (!bookings.length) {
            noHistory.style.display = 'block';
            return;
        } else {
            noHistory.style.display = 'none';
        }
        
        // Total number of bookings
        totalBookings.textContent = bookings.length;
        
        // Calculate average days between cleanings
        if (bookings.length > 1) {
            // Sort bookings by date
            const sortedBookings = [...bookings].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let totalDays = 0;
            let intervals = 0;
            
            for (let i = 1; i < sortedBookings.length; i++) {
                const prevDate = new Date(sortedBookings[i-1].date);
                const currDate = new Date(sortedBookings[i].date);
                
                const diffTime = Math.abs(currDate - prevDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                totalDays += diffDays;
                intervals++;
            }
            
            const averageDays = Math.round(totalDays / intervals);
            avgFrequency.textContent = averageDays;
        } else {
            avgFrequency.textContent = "N/A";
        }
    }
    
    // Render all services in browse view
    function renderServices(services) {
        servicesContainer.innerHTML = '';
        
        if (services.length === 0) {
            servicesContainer.innerHTML = `
                <div class="no-services">
                    <h3>No services found</h3>
                    <p>Try different search terms or filters</p>
                </div>
            `;
            return;
        }
        
        services.forEach(service => {
            const card = createServiceCard(service);
            servicesContainer.appendChild(card);
        });
    }
    
    // Render shortlisted services
    function renderShortlist() {
        shortlistContainer.innerHTML = '';
        
        if (shortlist.length === 0) {
            updateShortlistCount();
            return;
        }
        
        shortlist.forEach(service => {
            const card = createServiceCard(service);
            shortlistContainer.appendChild(card);
        });
        
        updateShortlistCount();
    }
    
    // Render booking history
    function renderBookingHistory(bookings) {
        historyContainer.innerHTML = '';
        
        if (bookings.length === 0) {
            historyContainer.innerHTML = `
                <div class="no-services">
                    <h3>No booking history found</h3>
                    <p>Try different search terms or make your first booking</p>
                </div>
            `;
            return;
        }
        
        // Sort bookings by date, newest first
        const sortedBookings = [...bookings].sort((a, b) => new Date(b.date) - new Date(a.date));
        
        sortedBookings.forEach(booking => {
            const historyItem = createHistoryItem(booking);
            historyContainer.appendChild(historyItem);
        });
    }
    
    // Show loader
    function showLoader(container) {
        container.innerHTML = `
            <div class="no-services">
                <h3>Loading...</h3>
            </div>
        `;
    }
    
    // Show error message
    function showError(container, message) {
        container.innerHTML = `
            <div class="no-services">
                <h3>Error</h3>
                <p>${message}</p>
            </div>
        `;
    }
    
    // Search services locally (used for shortlist search)
    function searchServicesLocally(keyword, servicesList) {
        if (!keyword) {
            return servicesList;
        }
        
        keyword = keyword.toLowerCase();
        return servicesList.filter(service => 
            service.title.toLowerCase().includes(keyword) || 
            service.description.toLowerCase().includes(keyword) ||
            service.category.toLowerCase().includes(keyword) ||
            service.provider.name.toLowerCase().includes(keyword)
        );
    }
    
    // Logout functionality
    function logout() {
        // In a real app, this would call an API endpoint to invalidate the session
        currentUser = null;
        shortlist = [];
        bookingHistory = [];
        
        // Update UI
        document.getElementById('username-display').textContent = 'Guest User';
        document.getElementById('welcome-username').textContent = 'Guest User';
        document.getElementById('user-avatar').textContent = 'G';
        
        updateShortlistCount();
        
        // Redirect to login page (in a real app)
        // window.location.href = '/login.html';
        
        // For this demo, just switch to the browse tab
        browseTab.click();
        
        // Close the logout modal
        logoutModal.style.display = 'none';
    }
    
    // Logout button event listener
    logoutBtn.addEventListener('click', function() {
        logoutModal.style.display = 'block';
    });
    
    // Logout modal event listeners
    closeLogoutModal.addEventListener('click', function() {
        logoutModal.style.display = 'none';
    });
    
    cancelLogoutButton.addEventListener('click', function() {
        logoutModal.style.display = 'none';
    });
    
    confirmLogoutButton.addEventListener('click', logout);
    
    // Event listeners for tabs
    browseTab.addEventListener('click', function() {
        browseTab.classList.add('active');
        shortlistTab.classList.remove('active');
        historyTab.classList.remove('active');
        browseContent.classList.add('active');
        shortlistContent.classList.remove('active');
        historyContent.classList.remove('active');
    });
    
    shortlistTab.addEventListener('click', function() {
        shortlistTab.classList.add('active');
        browseTab.classList.remove('active');
        historyTab.classList.remove('active');
        shortlistContent.classList.add('active');
        browseContent.classList.remove('active');
        historyContent.classList.remove('active');
        renderShortlist();
    });
    
    historyTab.addEventListener('click', function() {
        historyTab.classList.add('active');
        browseTab.classList.remove('active');
        shortlistTab.classList.remove('active');
        historyContent.classList.add('active');
        browseContent.classList.remove('active');
        shortlistContent.classList.remove('active');
        fetchBookingHistory();
    });
    
    // View shortlist button
    viewShortlistBtn.addEventListener('click', function() {
        shortlistTab.click();
    });
    
    // Search in main services
    searchBtn.addEventListener('click', function() {
        const keyword = searchInput.value.trim();
        if (keyword) {
            searchServicesAPI(keyword);
        } else {
            fetchServices();
        }
    });
    
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchBtn.click();
        }
    });
    
    // Search in shortlist
    shortlistSearchBtn.addEventListener('click', function() {
        const keyword = shortlistSearchInput.value.trim();
        const filteredShortlist = searchServicesLocally(keyword, shortlist);
        
        shortlistContainer.innerHTML = '';
        
        if (filteredShortlist.length === 0) {
            shortlistContainer.innerHTML = `
                <div class="no-services">
                    <h3>No matching services found in your shortlist</h3>
                    <p>Try different search terms</p>
                </div>
            `;
            return;
        }
        
        filteredShortlist.forEach(service => {
            const card = createServiceCard(service);
            shortlistContainer.appendChild(card);
        });
    });
    
    shortlistSearchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            shortlistSearchBtn.click();
        }
    });
    
    // Search in history
    historySearchBtn.addEventListener('click', function() {
        const keyword = historySearchInput.value.trim();
        searchBookingHistory(keyword);
    });
    
    historySearchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            historySearchBtn.click();
        }
    });
    
    // Browse services button in empty shortlist/history
    browseServicesBtn.addEventListener('click', function() {
        browseTab.click();
    });
    
    browseForBookingBtn.addEventListener('click', function() {
        browseTab.click();
    });
    
    // Clear shortlist button
    clearShortlistBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to clear your entire shortlist?')) {
            clearShortlist();
        }
    });
    
    // Service detail modal events
    closeDetailModal.addEventListener('click', function() {
        serviceDetailModal.style.display = 'none';
    });
    
    backToListBtn.addEventListener('click', function() {
        serviceDetailModal.style.display = 'none';
    });
    
    bookServiceBtn.addEventListener('click', function() {
        const serviceId = parseInt(this.getAttribute('data-id'));
        setupBooking(serviceId);
    });
    
    // Booking modal events
    closeBookingModal.addEventListener('click', function() {
        bookingModal.style.display = 'none';
    });
    
    cancelBooking.addEventListener('click', function() {
        bookingModal.style.display = 'none';
        serviceDetailModal.style.display = 'block';
    });
    
    bookingForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Get form values
        const serviceId = parseInt(bookingServiceId.value);
        const date = document.getElementById('booking-date').value;
        const time = document.getElementById('booking-time').value;
        const address = document.getElementById('booking-address').value;
        const notes = document.getElementById('booking-notes').value;
        
        const success = await createBooking(serviceId, date, time, address, notes);
        
        if (success) {
            alert(`Booking confirmed for ${bookingServiceTitle.textContent} on ${date} at ${time}`);
            
            // Close modal and reset form
            bookingModal.style.display = 'none';
            bookingForm.reset();
            
            // Switch to history tab to show the new booking
            historyTab.click();
        } else {
            alert('Failed to create booking. Please try again.');
        }
    });
    
    // Filter chip events
    const filterChips = document.querySelectorAll('.filter-chip');
    filterChips.forEach(chip => {
        chip.addEventListener('click', function() {
            // Update active state
            filterChips.forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            
            // Filter services
            const category = this.getAttribute('data-filter');
            fetchServicesByCategory(category);
        });
    });
    
    // Close modals when clicking outside
    window.addEventListener('click', function(e) {
        if (e.target === serviceDetailModal) {
            serviceDetailModal.style.display = 'none';
        }
        if (e.target === bookingModal) {
            bookingModal.style.display = 'none';
        }
        if (e.target === logoutModal) {
            logoutModal.style.display = 'none';
        }
    });
    
    // Mock API response for booking history
    function mockBookingHistory() {
        // For demo purposes, we'll mock some booking history data
        return [
            {
                id: 1,
                service: services[0],
                date: '2025-04-15',
                time: '09:00',
                address: '123 Main St, Apt 4B',
                notes: 'Please focus on kitchen and bathrooms',
                status: 'Completed'
            },
            {
                id: 2,
                service: services[2],
                date: '2025-04-30',
                time: '14:00',
                address: '123 Main St, Apt 4B',
                notes: '',
                status: 'Completed'
            },
            {
                id: 3,
                service: services[1],
                date: '2025-05-01',
                time: '10:00',
                address: '123 Main St, Apt 4B',
                notes: 'Please bring eco-friendly products',
                status: 'Upcoming'
            }
        ];
    }
    
    // Simulate user login (in a real app, this would come from authentication)
    function setupUserSession() {
        // For demo purposes, we'll use a hardcoded user
        // In a real app, you would get this from a login system
        currentUser = {
            user_id: 'user01',
            name: 'John Doe',
            email: 'john.doe@example.com'
        };
        
        // Update UI with user info
        document.getElementById('username-display').textContent = currentUser.name;
        document.getElementById('welcome-username').textContent = currentUser.name;
        document.getElementById('user-avatar').textContent = currentUser.name.charAt(0);
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
    // Setup user session
    setupUserSession();
    
    // Load initial services
    fetchServices();
    
    // Load shortlist
    fetchShortlist();
    
    // Set current date as default for booking
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('booking-date').min = today;
    document.getElementById('booking-date').value = today;
    
    // Initialize booking history with mock data ONLY if it's empty
    let historyInitialized = false;
    
    // Modified event handler for mock API response
    const fetchBookingHistoryOriginal = fetchBookingHistory;
    fetchBookingHistory = async function() {
        try {
            showLoader(historyContainer);
            
            // Only use mock data if history hasn't been initialized yet
            if (!historyInitialized && bookingHistory.length === 0) {
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Mock API response (initial data)
                bookingHistory = mockBookingHistory();
                historyInitialized = true;
            }
            
            // Always render whatever is in the bookingHistory array
            renderBookingHistory(bookingHistory);
            updateAnalytics(bookingHistory);
        } catch (error) {
            console.error('Error fetching booking history:', error);
            showError(historyContainer, 'Failed to load booking history');
        }
    };
});
</script>